<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#00ffe1" />
  <title>Mission Secure (Level 3 App)</title>

  

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: radial-gradient(circle at center, #00111a, #000);
      color:#00ffe1;
      text-align:center;
      padding: 12px;
    }
    h1{ margin: 8px 0 6px; font-size: 22px; }
    #wrap{ max-width: 980px; margin: 0 auto; }
    #gameBox{
      border:2px solid #00ffe1;
      padding: 14px;
      background: rgba(0,20,30,.9);
      box-shadow:0 0 20px #00ffe1;
      border-radius: 12px;
    }
    #scenario{ font-size: 18px; margin: 10px 0 14px; }
    #hud{ margin-top: 10px; font-size: 14px; opacity: .95; }
    .row{ display:flex; justify-content:center; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    button{
      padding: 12px 14px;
      margin: 6px;
      background:#002b36;
      color:#00ffe1;
      border:1px solid #00ffe1;
      cursor:pointer;
      font-size: 14px;
      border-radius: 10px;
      min-width: 220px;
    }
    button:hover{ background:#004d40; }
    button:disabled{ opacity: .45; cursor:not-allowed; }
    #buttons{ display:flex; flex-wrap: wrap; justify-content:center; gap: 6px; }

    #map{ margin-top: 10px; font-size: 14px; }
    .node{
      padding: 6px 10px;
      border:1px solid #00ffe1;
      display:inline-block;
      margin: 6px 6px 0 0;
      border-radius: 999px;
      white-space: nowrap;
    }
    .infected{ color:#ff4d4d; border-color:#ff4d4d; }

    .small{ font-size: 12px; opacity: .9; margin-top: 8px; }

    #toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 16px; background: rgba(0,0,0,.78);
      border: 1px solid #00ffe1; padding: 10px 12px;
      border-radius: 12px; display:none; max-width: 92vw;
    }

    #leaderboard{
      margin-top: 12px;
      text-align:left;
      border-top: 1px solid rgba(0,255,225,.25);
      padding-top: 10px;
      display:none;
    }
    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }
    th, td{
      border-bottom: 1px solid rgba(0,255,225,.2);
      padding: 8px 6px;
    }
    th{ text-align:left; opacity:.95; }

    /* Team name entry (no prompt()) */
    #nameEntry{
      display:none;
      margin-top: 12px;
      padding: 12px;
      border: 1px solid rgba(0,255,225,.25);
      border-radius: 12px;
      background: rgba(0,0,0,.25);
      text-align:center;
    }
    #teamNameInput{
      width: min(420px, 92%);
      padding: 10px 12px;
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid #00ffe1;
      background:#00111a;
      color:#00ffe1;
      outline: none;
      font-size: 14px;
    }
    #teamNameInput::placeholder{ color: rgba(0,255,225,.65); }
  </style>
</head>

<body>
  <div id="wrap">
    <h1>üöÄ Mission Secure (Level 3 App)</h1>

    <div class="row">
      <button id="startBtn">Start Mission</button>
      <button id="dlBtn" disabled>Download Leaderboard (CSV)</button>
      <button id="installBtn" style="display:none;">Install App</button>
    </div>

    <div id="gameBox">
      <div id="scenario">Press <b>Start Mission</b> to begin.</div>

      <div id="buttons"></div>

      <div id="hud">
        ‚è± <span id="time">90</span>s |
        ‚ù§Ô∏è <span id="health">100</span>% |
        ‚≠ê <span id="score">0</span>
      </div>

      <div id="map"></div>

      <div id="nameEntry">
        <b>Enter Team Name</b>
        <div class="small">This avoids pop-ups (prompt) that can be blocked on managed school computers.</div>
        <input id="teamNameInput" type="text" maxlength="30" placeholder="Team Atlas" autocomplete="off" />
        <div class="row" style="margin-top:8px;">
          <button id="saveTeamBtn" style="min-width: 220px;">Save Score</button>
          <button id="skipSaveBtn" style="min-width: 220px;">Skip</button>
        </div>
      </div>

      <div id="leaderboard">
        <b>Leaderboard</b>
        <div class="small">Stored on this device (offline-friendly). Download anytime.</div>
        <table id="lbTable">
          <thead><tr><th>Team</th><th>Score</th><th>When</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top:8px;">
          <button id="resetLbBtn" style="min-width: 220px;">Reset Leaderboard</button>
        </div>
      </div>
    </div>

    <div class="small">
      Tip: If your CMS blocks embeds, publish this app URL and link to it. Students can open it in a browser (and install it if allowed).
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
/** ------------------------------------------------------------------
 *  OPTIONAL PWA: install button + service worker registration
 *  (Safe even if you don't provide sw.js; it will just fail silently.)
 *  ------------------------------------------------------------------ */
let deferredPrompt = null;
const installBtn = document.getElementById("installBtn");

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = "inline-block";
});

installBtn.addEventListener("click", async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.style.display = "none";
});

// OPTIONAL: Service worker. If you do NOT have sw.js, you can delete this block.
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  });
}

/** ------------------------------------------------------------------
 *  DOM
 *  ------------------------------------------------------------------ */
const startBtn = document.getElementById("startBtn");
const dlBtn = document.getElementById("dlBtn");
const scenarioEl = document.getElementById("scenario");
const buttonsEl = document.getElementById("buttons");
const mapEl = document.getElementById("map");
const timeEl = document.getElementById("time");
const healthEl = document.getElementById("health");
const scoreEl = document.getElementById("score");
const toastEl = document.getElementById("toast");

const nameEntryEl = document.getElementById("nameEntry");
const teamNameInput = document.getElementById("teamNameInput");
const saveTeamBtn = document.getElementById("saveTeamBtn");
const skipSaveBtn = document.getElementById("skipSaveBtn");

const leaderboardBox = document.getElementById("leaderboard");
const lbTableBody = document.querySelector("#lbTable tbody");
const resetLbBtn = document.getElementById("resetLbBtn");

/** ------------------------------------------------------------------
 *  Helpers
 *  ------------------------------------------------------------------ */
function toast(msg, ms = 2000) {
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(() => (toastEl.style.display = "none"), ms);
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (c) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[c]));
}

function nowIso() {
  return new Date().toISOString();
}

/** ------------------------------------------------------------------
 *  Leaderboard (localStorage)
 *  ------------------------------------------------------------------ */
const LB_KEY = "mission_secure_lb_v1";

function loadLeaderboard() {
  try { return JSON.parse(localStorage.getItem(LB_KEY) || "[]"); }
  catch { return []; }
}

function saveLeaderboard(lb) {
  localStorage.setItem(LB_KEY, JSON.stringify(lb));
}

function renderLeaderboard() {
  const lb = loadLeaderboard()
    .slice()
    .sort((a, b) => (b.score - a.score))
    .slice(0, 25);

  lbTableBody.innerHTML = "";
  lb.forEach((e) => {
    const tr = document.createElement("tr");
    const when = new Date(e.ts);
    tr.innerHTML =
      "<td>" + escapeHtml(e.team) + "</td>" +
      "<td>" + e.score + "</td>" +
      "<td>" + when.toLocaleString() + "</td>";
    lbTableBody.appendChild(tr);
  });

  leaderboardBox.style.display = lb.length ? "block" : "none";
  dlBtn.disabled = !lb.length;
}

/** ------------------------------------------------------------------
 *  Game content
 *  ------------------------------------------------------------------ */
const networkNodes = ["Life Support", "Comms", "Satellite", "Food System", "Navigation"];

const scenarios = [
  {
    text: "Life Support monitoring is offline!",
    options: [
      { text: "Check connections & restart", correct: true, points: 10 },
      { text: "Assume hackers; shut everything down", correct: false }
    ],
    lesson: "IT Support: start with basics (power, cables, restart)."
  },
  {
    text: "Message received: 'URGENT‚Äîlog in here to fix power levels!'",
    options: [
      { text: "Click the link immediately", correct: false },
      { text: "Verify sender & report phishing", correct: true, points: 15 }
    ],
    lesson: "Cybersecurity: phishing tricks humans into giving access."
  },
  {
    text: "Unknown device is trying to access satellite controls.",
    options: [
      { text: "Block traffic with the firewall", correct: true, points: 15 },
      { text: "Ignore it", correct: false }
    ],
    lesson: "Network defense: block suspicious traffic; reduce attack paths."
  },
  {
    text: "Crew member forgot their password.",
    options: [
      { text: "Share your login so they can work", correct: false },
      { text: "Reset password securely", correct: true, points: 10 }
    ],
    lesson: "Access control: never share credentials; reset properly."
  },
  {
    text: "Two problems: security alert + a system outage.",
    options: [
      { text: "Fix the outage first", correct: false },
      { text: "Handle the security alert first", correct: true, points: 20 }
    ],
    lesson: "Operations: prioritize threats that could impact everything."
  }
];

/** ------------------------------------------------------------------
 *  Game state
 *  ------------------------------------------------------------------ */
let health = 100;
let score = 0;
let timeLeft = 90;
let timer = null;
let round = 0;
let infectedNode = null;
let gameActive = false;

/** ------------------------------------------------------------------
 *  UI rendering
 *  ------------------------------------------------------------------ */
function updateHUD() {
  timeEl.textContent = String(timeLeft);
  healthEl.textContent = String(health);
  scoreEl.textContent = String(score);
}

function drawMap() {
  mapEl.innerHTML = "<b>Network Map:</b><br/>";
  networkNodes.forEach((n) => {
    const span = document.createElement("span");
    span.className = "node" + (n === infectedNode ? " infected" : "");
    span.textContent = n + (n === infectedNode ? " (INFECTED)" : "");
    mapEl.appendChild(span);
  });
}

function setOptions(options) {
  buttonsEl.innerHTML = "";
  options.forEach((o) => {
    const btn = document.createElement("button");
    btn.textContent = o.text;
    btn.onclick = () => onChoice(o);
    buttonsEl.appendChild(btn);
  });
}

function hideNameEntry() {
  nameEntryEl.style.display = "none";
  teamNameInput.value = "";
}

function showNameEntry() {
  nameEntryEl.style.display = "block";
  teamNameInput.focus();
}

/** ------------------------------------------------------------------
 *  Game flow
 *  ------------------------------------------------------------------ */
function startMission() {
  clearInterval(timer);
  timer = null;

  health = 100;
  score = 0;
  timeLeft = 90;
  round = 0;
  infectedNode = null;
  gameActive = true;

  hideNameEntry();
  leaderboardBox.style.display = "none";
  scenarioEl.innerHTML = "Mission started. Stay sharp.";
  updateHUD();
  drawMap();

  timer = setInterval(() => {
    if (!gameActive) return;
    timeLeft--;
    updateHUD();
    if (timeLeft <= 0) finishMission("‚è± Time‚Äôs up. Mission ended.");
  }, 1000);

  nextStep();
}

function nextStep() {
  if (!gameActive) return;

  if (health <= 0) {
    finishMission("üí• Station failed. Systems compromised.");
    return;
  }

  if (round < scenarios.length) {
    const s = scenarios[round];
    scenarioEl.textContent = s.text;
    setOptions(s.options);
    drawMap();
    return;
  }

  ransomwareBoss();
}

function onChoice(option) {
  if (!gameActive) return;

  // Boss options
  if (option.boss) {
    if (option.correct) {
      score += option.points || 0;
      updateHUD();
      toast("üéâ Contained! Isolation prevents spread; recovery can proceed.", 2400);
      finishMission("‚úÖ Mission success. Ransomware contained.");
    } else {
      health = 0;
      updateHUD();
      toast("üí• Compromised! The attack spread across critical systems.", 2400);
      finishMission("üí• Mission failed. Ransomware spread across critical systems.");
    }
    return;
  }

  // Normal scenarios
  const s = scenarios[round];
  if (option.correct) {
    score += option.points || 0;
    toast("‚úÖ Correct: " + s.lesson, 2400);
  } else {
    health -= 15;
    toast("‚ùå Wrong: station damaged. Think like an IT/Cyber team.", 2400);
  }

  round++;
  updateHUD();
  setTimeout(nextStep, 250);
}

function ransomwareBoss() {
  infectedNode = networkNodes[Math.floor(Math.random() * networkNodes.length)];
  drawMap();
  scenarioEl.textContent =
    "ü¶† RANSOMWARE! " + infectedNode + " is infected and encrypting files. What do you do?";

  setOptions([
    { text: "Isolate/disconnect the infected system", correct: true, points: 30, boss: true },
    { text: "Pay the ransom to restore access", correct: false, boss: true },
    { text: "Ignore and hope it stops", correct: false, boss: true }
  ]);
}

function finishMission(message) {
  if (!gameActive) return;

  gameActive = false;
  clearInterval(timer);
  timer = null;

  buttonsEl.innerHTML = "";
  scenarioEl.textContent = message;

  showNameEntry();
}

function saveScore(teamName) {
  const team = (teamName || "").trim() || "Team";
  const entry = { team: team, score: score, ts: nowIso() };

  const lb = loadLeaderboard();
  lb.push(entry);
  saveLeaderboard(lb);
  renderLeaderboard();

  hideNameEntry();
  leaderboardBox.style.display = "block";

  infectedNode = null;
  drawMap();
}

/** ------------------------------------------------------------------
 *  Downloads / reset
 *  ------------------------------------------------------------------ */
function downloadLeaderboardCsv() {
  const lb = loadLeaderboard();
  if (!lb.length) return;

  const rows = [["Team", "Score", "Timestamp"]].concat(
    lb.map((e) => [e.team, String(e.score), e.ts])
  );

  const csv = rows
    .map((r) => r.map((cell) => "\"" + String(cell).replaceAll("\"", "\"\"") + "\"").join(","))
    .join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "mission_secure_leaderboard.csv";
  a.click();
}

function resetLeaderboard() {
  if (!confirm("Reset leaderboard on this device?")) return;
  saveLeaderboard([]);
  renderLeaderboard();
  toast("Leaderboard reset.", 1800);
}

/** ------------------------------------------------------------------
 *  Event wiring
 *  ------------------------------------------------------------------ */
startBtn.addEventListener("click", startMission);
dlBtn.addEventListener("click", downloadLeaderboardCsv);
resetLbBtn.addEventListener("click", resetLeaderboard);

saveTeamBtn.addEventListener("click", () => saveScore(teamNameInput.value));

skipSaveBtn.addEventListener("click", () => {
  hideNameEntry();
  infectedNode = null;
  drawMap();
  leaderboardBox.style.display = loadLeaderboard().length ? "block" : "none";
});

teamNameInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") saveScore(teamNameInput.value);
});

/** ------------------------------------------------------------------
 *  Initial render
 *  ------------------------------------------------------------------ */
renderLeaderboard();
drawMap();
updateHUD();
</script>
</body>
</html>
